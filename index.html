<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Say The Word On Beat â€” Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</title>
  <style>
    :root{
      --bg1:#070b14; --bg2:#0b1533;
      --text:#f3f6ff; --muted:#a9b7da;
      --ok:#2dd4bf; --bad:#fb7185; --warn:#fbbf24;
      --stroke: rgba(255,255,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    
    html { overflow-y: scroll; } /* Ù„Ù…Ù†Ø¹ Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„ØµÙØ­Ø© */

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans Arabic", "Noto Kufi Arabic", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 50% 10%, rgba(255,203,90,.38), transparent 55%),
        radial-gradient(900px 600px at 12% 70%, rgba(122,92,255,.26), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
      padding:14px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      -webkit-text-size-adjust: 100%;
    }

    .app{
      width:min(1200px, 100%); 
      display:grid; 
      grid-template-columns: 1fr; 
      gap:20px;
    }

    /* ØªØ®Ø·ÙŠØ· Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
    @media (min-width: 900px) {
      .app {
        grid-template-columns: 1fr 350px; 
        align-items: start;
      }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:20px;
      backdrop-filter: blur(10px);
    }

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .stageWrap{display:flex; justify-content:center; margin:0 0 16px;}
    .stageBanner{
      position:relative; padding:10px 24px; 
      border-radius:999px; 
      background: linear-gradient(90deg, #6d28d9, #9333ea, #7c3aed); 
      border:1px solid rgba(255,255,255,.22); 
      box-shadow: 0 10px 30px rgba(0,0,0,.25); 
      font-weight:900; font-size:24px; 
      text-align:center; min-width: 180px;
    }

    /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats{
      display:grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap:8px; 
      margin-bottom:16px;
    }
    .pill{
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
      gap:4px; padding:10px 8px; 
      border-radius:14px; 
      background: rgba(0,0,0,.22); 
      border:1px solid var(--stroke); 
      color:var(--muted); font-size:12px;
    }
    .pill b{
      color:var(--text); font-size:18px; 
      font-variant-numeric: tabular-nums;
    }
    .pill .mono{font-family: ui-monospace, monospace;}

    /* Ø§Ù„Ø´Ø¨ÙƒØ© */
    .grid{
      display:grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap:14px; 
      margin-bottom:20px;
    }

    .card{
      position:relative; aspect-ratio: 1 / 1;
      border-radius: 18px;
      border:2px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:flex; align-items:stretch; justify-content:stretch;
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
      transition: transform 0.1s;
    }
    .cardInner{width:100%; height:100%; padding:8px; display:grid; grid-template-rows: 1fr auto; gap:6px;}
    
    .iconBox{
      border-radius: 14px; display:flex; align-items:center; justify-content:center;
      font-size:42px; border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      background: rgba(255,255,255,.03);
    }
    .wordLabel{
      text-align:center; font-weight:800; font-size:18px;
      padding:6px 4px; border-radius: 10px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
    }

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .t-green .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(34,197,94,.6), rgba(16,185,129,.2));}
    .t-blue  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(59,130,246,.6), rgba(99,102,241,.2));}
    .t-gold  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(251,191,36,.6), rgba(245,158,11,.2));}
    .t-red   .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(239,68,68,.6), rgba(251,113,133,.2));}
    .t-purple .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(168,85,247,.6), rgba(99,102,241,.2));}
    .t-pink  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(236,72,153,.6), rgba(168,85,247,.2));}
    .t-gray  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.2), transparent 60%), linear-gradient(180deg, rgba(148,163,184,.4), rgba(59,130,246,.1));}

    .card.active{
      border-color: rgba(251,191,36,.9);
      box-shadow: 0 0 0 4px rgba(251,191,36,.25), 0 20px 50px rgba(0,0,0,.4);
      transform: translateY(-2px);
      z-index: 2;
    }
    .card.active::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(circle at 50% 50%, rgba(251,191,36,.2), transparent 70%);
      animation: pulse .6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulse{ 0%{opacity:.3;} 50%{opacity:.8;} 100%{opacity:.3;} }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .playWrap{display:flex; flex-direction:column; gap:10px;}
    .playBtn{
      width:100%;
      border:0; border-radius: 16px;
      padding:16px;
      font-weight:900; font-size:18px;
      color:var(--text);
      background: rgba(45,212,191,.15);
      border:1px solid rgba(45,212,191,.4);
      cursor:pointer;
      transition: all .2s;
    }
    .playBtn:hover:not(:disabled){background: rgba(45,212,191,.25);}
    .playBtn:active:not(:disabled){transform: scale(0.98);}
    .playBtn:disabled{opacity:.5; cursor:not-allowed; transform:none;}
    .nextBtn{background: rgba(99,102,241,.15); border-color: rgba(99,102,241,.4);}
    .nextBtn:hover:not(:disabled){background: rgba(99,102,241,.25);}

    /* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .h2{margin:0 0 12px; font-size:16px; font-weight:800; display:flex; align-items:center; gap:6px;}
    .row{display:grid; gap:6px; margin-bottom:14px;}
    label{display:flex; justify-content:space-between; color:var(--muted); font-size:13px; font-weight:600;}
    
    input[type="range"]{width:100%; cursor:pointer; accent-color: var(--ok);}
    select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid var(--stroke); background: rgba(0,0,0,.3);
      color:var(--text); outline:none; font-size:14px;
    }

    /* Ø§Ù„Ø³Ø¬Ù„ */
    .log{
      max-height: 400px; overflow-y:auto; 
      display:flex; flex-direction:column; gap:8px;
      padding-right: 4px;
    }
    .log::-webkit-scrollbar {width: 6px;}
    .log::-webkit-scrollbar-thumb {background: rgba(255,255,255,0.1); border-radius: 10px;}
    
    .logItem{
      padding:10px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.2);
      color:var(--muted); font-size:13px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .logItem div:first-child { flex: 1; line-height: 1.4; } /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */

    .tag{
      padding:4px 8px; border-radius:6px;
      font-weight:700; font-size:11px;
      border:1px solid rgba(255,255,255,.1);
      white-space:nowrap;
    }
    .tag.ok{color:#2dd4bf; background: rgba(45,212,191,.1);}
    .tag.bad{color:#fb7185; background: rgba(251,113,133,.1);}
    .tag.warn{color:#fbbf24; background: rgba(251,191,36,.1);}

    /* Ø§Ù„Ù†ÙˆØ§ÙØ° */
    .modal.hidden{display:none}
    .modal{position:fixed; inset:0; z-index:100; display:flex; align-items:center; justify-content:center; padding:16px;}
    .modalBackdrop{position:absolute; inset:0; background: rgba(0,0,0,.7); backdrop-filter: blur(5px);}
    .modalCard{
      position:relative; width:min(500px, 100%); 
      border-radius:24px; border:1px solid rgba(255,255,255,.15);
      background: #12182b; 
      box-shadow: 0 24px 80px rgba(0,0,0,.6);
      padding:20px;
    }
    .modalHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;}
    .modalTitle{font-weight:900; font-size:20px;}
    .modalX{
      border:0; background: rgba(255,255,255,.1); color: var(--text);
      width:32px; height:32px; border-radius:50%; cursor:pointer; font-weight:bold;
    }
    .modalActions{display:grid; gap:10px; margin-top:20px;}

    /* Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 600px){
      .app{gap:14px;}
      .panel{padding:14px;}
      .grid{grid-template-columns: repeat(2, 1fr); gap:10px;}
      .stats{grid-template-columns: repeat(2, 1fr); gap:6px;}
      .pill{flex-direction: row; justify-content: space-between; padding: 8px 12px; min-height: auto;}
      .pill span {font-size: 11px;}
      .pill b {font-size: 14px;}
      .iconBox{font-size: 36px; height: 70px;} 
      .wordLabel{font-size:16px;}
      .playBtn{font-size:16px; padding:14px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="stageWrap"><div class="stageBanner" id="stageTitle">Ø¨ÙÙ„Ù‘Ø¨ÙÙ„Ù‘Ù’</div></div>

      <div class="stats">
        <div class="pill"><span>ğŸ§© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span> <b id="groupLabelDisp">1/16</b></div>
        <div class="pill"><span>ğŸšï¸ Ø§Ù„Ø³Ø±Ø¹Ø©</span> <b id="bpmText">110</b></div>
        <div class="pill"><span>ğŸ¯ Ø§Ù„Ø¯ÙˆØ±</span> <b id="stepText">1/8</b></div>
        <div class="pill"><span>â­ Ø³ÙƒÙˆØ±</span> <b id="scoreText">0</b></div>
        <div class="pill"><span>ğŸ™ï¸ Ø§Ù„Ù…Ø§ÙŠÙƒ</span> <b id="micState">..</b></div>
        <div class="pill"><span>ğŸ§  Ø§Ù„ØªØ¹Ø±Ù</span> <b id="asrState">..</b></div>
        <div class="pill" style="grid-column: span 2; justify-content:center">
           <span style="margin-left:6px">ğŸ—£ï¸ Ø³Ù…Ø¹Øª:</span> <b class="mono" id="lastHeard" style="direction:ltr; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:120px">â€”</b>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="playWrap">
        <button class="playBtn" id="playBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>
        <button class="playBtn nextBtn" id="nextStageBtn">â­ï¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
      </div>
    </div>

    <div class="panel">
      <div class="h2">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      
      <div class="row">
        <label><span>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span><span id="groupLabel">1</span></label>
        <input type="range" id="group" min="1" max="16" value="1">
      </div>

      <div class="row">
        <label><span>Ø§Ù„Ø³Ø±Ø¹Ø© (BPM)</span><span id="bpmLabel">110</span></label>
        <input type="range" id="bpm" min="70" max="160" value="110">
      </div>

      <div class="row">
        <label><span>Ø§Ù„Ù„ØºØ©</span></label>
        <select id="asrLang">
          <option value="ar-SA" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)</option>
          <option value="ar-EG">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù…ØµØ±)</option>
          <option value="ar-IQ">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø¹Ø±Ø§Ù‚)</option>
          <option value="ar-AE">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª)</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¹Ø§Ù…)</option>
        </select>
      </div>

      <div class="row">
        <label><span>Ø§Ù„ØªØ³Ø§Ù‡Ù„</span></label>
        <select id="sens">
          <option value="strict">ØµØ§Ø±Ù… (ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù…)</option>
          <option value="normal">Ù…ØªÙˆØ³Ø·</option>
          <option value="loose" selected>Ù…ØªØ³Ø§Ù‡Ù„ (ÙŠÙˆØµÙ‰ Ø¨Ù‡)</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="resetBtn" style="width:100%; border-radius:12px;padding:12px;font-weight:700;color:var(--muted);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);cursor:pointer; transition:.2s">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      </div>

      <div style="height:1px; background:var(--stroke); margin:16px 0;"></div>

      <div class="h2">
        <span>ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span>
        <span id="totalScoreText" style="margin-right:auto; color:var(--warn); font-variant-numeric: tabular-nums;">0</span>
      </div>
      <div class="log" id="log"></div>
    </div>
  </div>


  <div id="introModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalBackdrop" id="introBackdrop"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalTitle">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙÙ„Ù‘Ø¨ÙÙ„Ù‘Ù’</div>
        <button class="modalX" id="introClose">âœ•</button>
      </div>
      <div style="line-height:1.6; color:var(--muted); font-size:15px;">
        <p>Ù„Ø¹Ø¨Ø© ØµÙˆØªÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±Ø¹Ø© Ø¨Ø¯ÙŠÙ‡ØªÙƒ ÙˆÙ†Ø·Ù‚Ùƒ.</p>
        <ul style="padding-right:20px; margin:10px 0;">
          <li>Ø³ÙŠØ¸Ù‡Ø± Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠØŒ Ø«Ù… ÙŠØ¶ÙŠØ¡ Ù…Ø±Ø¨Ø¹.</li>
          <li>Ø§Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø© ÙÙˆØ±Ø§Ù‹.</li>
          <li>ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø§ Ù‚Ù„ØªÙ‡.</li>
        </ul>
      </div>
      <div class="modalActions">
        <button class="playBtn" id="introOk">âœ… ÙÙ‡Ù…Øª</button>
        <div style="color:var(--bad); font-size:13px; text-align:center; font-weight:800; margin-top:8px;">
          Ù„ØªØ¬Ø±Ø¨Ø© Ù„Ø¹Ø¨ Ø£ÙØ¶Ù„ Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
        </div>
      </div>
    </div>
  </div>

  <div id="finalModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalBackdrop" id="finalBackdrop"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalTitle">ğŸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
        <button class="modalX" id="finalClose">âœ•</button>
      </div>
      <div style="text-align:center; padding:20px 0;">
        <div style="font-size:40px; font-weight:900; color:var(--ok); margin-bottom:10px" id="finalScoreLine">0</div>
        <div style="color:var(--muted)" id="finalDetailLine">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
      </div>
      <div class="modalActions" style="grid-template-columns: 1fr 1fr;">
        <button class="playBtn nextBtn" id="finalRestart">ğŸ” Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button class="playBtn" id="finalOk">âœ… Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
    const now=()=>performance.now();

    function normalizeArabic(s){
      return (s||"")
        .toLowerCase()
        .replace(/[Ù‘ÙÙ‹ÙÙŒÙÙÙ’Ù€]/g,"")
        .replace(/[Ø£Ø¥Ø¢Ø§]/g,"Ø§")
        .replace(/[Ù‰ÙŠ]/g,"ÙŠ")
        .replace(/[Ø©]/g,"Ù‡")
        .replace(/[Ø¤]/g,"Ùˆ")
        .replace(/[Ø¦]/g,"ÙŠ")
        .replace(/[^\u0600-\u06FF0-9a-z ]+/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    // ===== Speech Recognition =====
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer=null;
    let recogRunning=false;

    let finalTranscript = "";    
    let lastInterim = "";        
    let allowAsrRestart = false;
    let asrPhase = "idle"; 

    function setMicState(txt){ $("micState").textContent = txt; }
    function setAsrState(txt){ $("asrState").textContent = txt; }
    function isSpeechSupported(){ return !!SpeechRec; }
    function isSecure(){ return (window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1"); }

    function setupRecognizer(){
      if(!SpeechRec) return false;
      recognizer = new SpeechRec();
      recognizer.lang = $("asrLang").value || "ar-SA";
      recognizer.interimResults = true;
      recognizer.continuous = true;
      recognizer.maxAlternatives = 1; 

      recognizer.onstart = ()=> { setAsrState("ÙŠØ¹Ù…Ù„"); };

      recognizer.onresult = (ev)=>{
        const segs = [];
        for(let i=0;i<ev.results.length;i++){
          const r = ev.results[i];
          const txtRaw = (r && r[0] && r[0].transcript) ? r[0].transcript : "";
          const seg = normalizeArabic(txtRaw);
          if(seg) segs.push(seg);
        }

        let merged = "";
        for(const seg of segs){
          if(!merged){ merged = seg; continue; }
          if(seg.startsWith(merged)){ merged = seg; continue; }
          if(merged.startsWith(seg)){ continue; }
          
          const a = merged.split(" ");
          const b = seg.split(" ");
          let overlap = 0;
          const max = Math.min(a.length, b.length);
          for(let k=max; k>=1; k--){
            if(a.slice(-k).join(" ") === b.slice(0,k).join(" ")){ overlap = k; break; }
          }
          merged = a.concat(b.slice(overlap)).join(" ");
        }

        finalTranscript = normalizeArabic(merged);
        lastInterim = "";
        $("lastHeard").textContent = finalTranscript ? (finalTranscript.slice(-15)) : "â€”";
      };

      recognizer.onerror = (e)=>{
        const err = (e && e.error) ? e.error : "Unknown";
        if(err === "no-speech") return; 
        setAsrState("!" + err);
        if(err === "audio-capture" || err === "network"){ allowAsrRestart = true; }
      };

      recognizer.onend = ()=>{
        if(recogRunning && allowAsrRestart && asrPhase === "playing"){
          try{ recognizer.start(); }catch(e){}
        }else{ setAsrState("Ø®Ø§Ù…Ù„"); }
      };
      return true;
    }

    async function startMicAuto(){
      if(!isSecure()){
        log("Ø§Ù„Ù†Ø¸Ø§Ù…","ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS","bad");
        return false;
      }
      if(!isSpeechSupported()){
        log("Ø§Ù„Ù†Ø¸Ø§Ù…","ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…","bad");
        return false;
      }
      if(!recognizer && !setupRecognizer()){ return false; }

      try{
        recogRunning=true;
        finalTranscript = "";
        lastInterim = "";
        $("lastHeard").textContent = "â€”";
        allowAsrRestart = true;
        asrPhase = "playing";
        recognizer.lang = $("asrLang").value || "ar-SA";
        recognizer.start();
        setMicState("Ù…ÙØ¹Ù„");
        return true;
      }catch(e){
        setMicState("Ø®Ø·Ø£");
        return false;
      }
    }

    function hardStopMic(){
      allowAsrRestart = false;
      recogRunning = false;
      asrPhase = "idle";
      try{ if(recognizer) recognizer.stop(); }catch(e){}
      setMicState("Ù…ØºÙ„Ù‚");
      setAsrState("Ø®Ø§Ù…Ù„");
    }

    // ===== Data =====
    const WORDS = ["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø­Ø§Ø±","Ù†Ø§Ø±","Ø·Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø³ÙˆÙ‚","ÙÙˆÙ‚","ÙØ§Ø±","Ø¬Ø§Ø±"];
    const ICONS = {"Ù†Ø§Ù‚Ø©":"ğŸª","Ø¨Ø§Ù‚Ø©":"ğŸ’","Ø¨ÙˆÙ‚":"ğŸº","Ø­Ø§Ø±":"ğŸŒ¶ï¸","Ù†Ø§Ø±":"ğŸ”¥","Ø·Ø§Ù‚Ø©":"ğŸ’¡","Ø·ÙˆÙ‚":"ğŸ“¿","Ø³ÙˆÙ‚":"ğŸ›’","ÙÙˆÙ‚":"â¬†ï¸","ÙØ§Ø±":"ğŸ­","Ø¬Ø§Ø±":"ğŸšª"};
    const THEME = {"Ù†Ø§Ù‚Ø©":"t-gold","Ø¨Ø§Ù‚Ø©":"t-pink","Ø¨ÙˆÙ‚":"t-purple","Ø­Ø§Ø±":"t-red","Ù†Ø§Ø±":"t-red","Ø·Ø§Ù‚Ø©":"t-green","Ø·ÙˆÙ‚":"t-blue","Ø³ÙˆÙ‚":"t-gold","ÙÙˆÙ‚":"t-gray","ÙØ§Ø±":"t-gray","Ø¬Ø§Ø±":"t-blue"};

    const GROUPS = [
      { tiles:["Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©"] },
      { tiles:["Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©"] },
      { tiles:["Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚"] },
      { tiles:["Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] },
      { tiles:["Ø¨Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] },
      { tiles:["Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","ÙÙˆÙ‚","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©"] },
      { tiles:["Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±"] },
      { tiles:["Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±"] },
      { tiles:["Ù†Ø§Ø±","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø­Ø§Ø±","Ù†Ø§Ø±"] },
      { tiles:["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø·ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ø±","Ø­Ø§Ø±"] },
      { tiles:["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø³ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©"] },
      { tiles:["Ø­Ø§Ø±","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±"] },
      { tiles:["Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ù†Ø§Ø±","Ù†Ø§Ù‚Ø©"] },
      { tiles:["Ø¨Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©"] },
      { tiles:["Ø·Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø·ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©"] },
      { tiles:["ÙØ§Ø±","Ø­Ø§Ø±","Ù†Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø¬Ø§Ø±","ÙØ§Ø±","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] }
    ];

    let groupIndex=0;
    let bpm=110;
    let intervalMs=60000/bpm;
    let running=false;
    let timer=null;
    let activePos=0;
    let score=0; 
    let groupScores = new Array(GROUPS.length).fill(0);
    let totalScore = 0;
    let lastRawRound = ""; 

    function currentGroup(){ return GROUPS[groupIndex]; }
    function expectedWord(pos){ return currentGroup().tiles[pos] || ""; }

    function log(tag, msg, type){
      const item=document.createElement("div");
      item.className="logItem";
      const left=document.createElement("div");
      left.textContent=msg;
      const t=document.createElement("div");
      t.className=`tag ${type||""}`;
      t.textContent=tag;
      item.appendChild(left);
      item.appendChild(t);
      const logEl = $("log");
      logEl.prepend(item);
    }

    function updateHUD(){
      $("groupLabelDisp").textContent = `${groupIndex+1}/${GROUPS.length}`;
      $("groupLabel").textContent = `${groupIndex+1}`;
      $("bpmText").textContent = bpm;
      $("bpmLabel").textContent = bpm;
      $("stepText").textContent = (activePos+1) + "/8";
      $("scoreText").textContent = score;
      $("totalScoreText").textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: " + totalScore;
    }

    function buildGrid(){
      const g=$("grid");
      g.innerHTML="";
      const tiles=currentGroup().tiles;
      tiles.forEach((w,i)=>{
        const card=document.createElement("div");
        card.className = `card ${THEME[w]||""}`;
        card.dataset.pos = String(i);
        const inner=document.createElement("div");
        inner.className="cardInner";
        const icon=document.createElement("div");
        icon.className="iconBox";
        icon.textContent = ICONS[w] || "âœ¨";
        const label=document.createElement("div");
        label.className="wordLabel";
        label.textContent = w;
        inner.appendChild(icon);
        inner.appendChild(label);
        card.appendChild(inner);
        g.appendChild(card);
      });
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
    }

    function setActive(pos){
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
      if(pos >= 8) return;
      const el=document.querySelector(`.card[data-pos="${pos}"]`);
      if(el) el.classList.add("active");
      activePos=pos;
      updateHUD();
    }

    function voiceMatchesExpected(heard, expected){
      const h=normalizeArabic(heard);
      const e=normalizeArabic(expected);
      if(!h || !e) return false;
      const mode=$("sens").value;
      if(mode==="strict") return h===e;
      if(h===e) return true;
      if(h.includes(e) || e.includes(h)) return true;
      if(mode==="loose"){
        let matchCount = 0;
        for(let char of e){ if(h.includes(char)) matchCount++; }
        if(matchCount >= e.length - 1) return true;
      }
      return false;
    }

    function extractFirstNWords(text, n){
      const t = normalizeArabic(text);
      if(!t) return [];
      const tokens = t.split(" ").filter(Boolean);
      return tokens.slice(0, n);
    }

    // ===== Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ =====
    function finalizeRoundAndVerify(){
      const raw = (finalTranscript || lastInterim || "").trim();
      lastRawRound = raw || "";
      const saidSeq = extractFirstNWords(raw, 8); 

      score = 0;

      // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
      if(raw) log("Ø³Ù…Ø¹Øª", `Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„: "${raw}"`, "warn");
      else log("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙŠ ØµÙˆØª", "bad");

      // Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ ÙƒÙ„Ù…Ø©
      for(let i=0;i<8;i++){
        const expected = expectedWord(i);
        const said = saidSeq[i] || "â€”";
        const ok = (said !== "â€”") && voiceMatchesExpected(said, expected);
        
        if(ok){
          score += 10;
          log("âœ… ØµØ­", `#${i+1} Ù‚Ù„Øª: "${said}" | Ù…Ø·Ù„ÙˆØ¨: "${expected}"`, "ok");
        }else{
          log("âŒ Ø®Ø·Ø£", `#${i+1} Ù‚Ù„Øª: "${said}" | Ù…Ø·Ù„ÙˆØ¨: "${expected}"`, "bad");
        }
      }

      groupScores[groupIndex] = score;
      totalScore = groupScores.reduce((a,b)=>a+(b||0), 0);
      updateHUD();
      
      log("Ø§Ù„Ù†ØªÙŠØ¬Ø©", `Ø§Ù„Ø¬ÙˆÙ„Ø© ${groupIndex+1}: ${score}/80`, score===80?"ok":"warn");
    }

    function scheduleNext(){
      if(!running) return;
      timer = setTimeout(()=>{
        if(!running) return;
        const next = activePos + 1;
        if(next >= 8){ finishRound(); return; }
        setActive(next);
        scheduleNext();
      }, intervalMs);
    }

    async function finishRound(){
      running=false;
      if(timer) clearTimeout(timer);
      timer=null;
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
      asrPhase = "ending";
      allowAsrRestart = false;
      try{ if(recognizer) recognizer.stop(); }catch(e){}
      await new Promise(r=>setTimeout(r, 1000));
      finalizeRoundAndVerify();
      hardStopMic();
      $("playBtn").disabled=false;
      $("nextStageBtn").disabled=false;
      $("playBtn").textContent = "â–¶ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨";
    }

    async function startGame(){
      if(running) return;
      const playEl = $("playBtn");
      const nextEl = $("nextStageBtn");
      playEl.disabled=true;
      nextEl.disabled=true;
      for(let i=3;i>=1;i--){
        playEl.textContent = `â³ ${i}`;
        await new Promise(r=>setTimeout(r, 400));
      }
      playEl.textContent = "ğŸ™ï¸ ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†!";
      $("log").innerHTML = ""; 
      bpm = clamp(parseInt($("bpm").value,10)||110, 40, 220);
      intervalMs = 60000 / bpm;
      await startMicAuto();
      running=true;
      score=0;
      activePos=0;
      buildGrid(); 
      if(timer) clearTimeout(timer);
      setActive(0);
      scheduleNext();
    }

    function loadGroup(idx){
      groupIndex = clamp(idx, 0, GROUPS.length-1);
      running=false;
      if(timer) clearTimeout(timer);
      hardStopMic();
      score = groupScores[groupIndex] || 0;
      totalScore = groupScores.reduce((a,b)=>a+(b||0), 0);
      activePos=0;
      finalTranscript="";
      lastInterim="";
      $("lastHeard").textContent="â€”";
      buildGrid();
      updateHUD();
      $("playBtn").disabled=false;
      $("nextStageBtn").disabled=false;
      $("playBtn").textContent = "â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨";
    }

    $("playBtn").addEventListener("click", startGame);
    $("nextStageBtn").addEventListener("click", ()=>{
      if(running) return;
      if(groupIndex === GROUPS.length - 1){ showFinalModal(); return; }
      const next = groupIndex + 1;
      $("group").value = String(next + 1);
      loadGroup(next);
    });

    $("group").addEventListener("input", (e)=>{ loadGroup((parseInt(e.target.value,10)||1)-1); });
    $("bpm").addEventListener("input", (e)=>{ bpm = clamp(parseInt(e.target.value,10)||110, 40, 220); $("bpmLabel").textContent=bpm; });
    $("asrLang").addEventListener("change", ()=>{ if(recogRunning) hardStopMic(); log("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©", "warn"); });
    
    $("resetBtn").addEventListener("click", ()=>{
      groupScores.fill(0); totalScore = 0; score=0;
      $("log").innerHTML=""; updateHUD();
      log("Ø§Ù„Ù†Ø¸Ø§Ù…","ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬","warn");
    });

    function showFinalModal(){
      const pct = Math.round((totalScore / (GROUPS.length * 80)) * 100);
      $("finalScoreLine").textContent = `${totalScore}`;
      $("finalDetailLine").textContent = `Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${pct}%`;
      $("finalModal").classList.remove("hidden");
    }
    function hideFinalModal(){ $("finalModal").classList.add("hidden"); }
    $("finalClose").addEventListener("click", hideFinalModal);
    $("finalOk").addEventListener("click", hideFinalModal);
    $("finalRestart").addEventListener("click", ()=>{ hideFinalModal(); $("group").value = "1"; loadGroup(0); });

    function showIntroModal(){ $("introModal").classList.remove("hidden"); }
    function hideIntroModal(){ $("introModal").classList.add("hidden"); }
    $("introClose").addEventListener("click", hideIntroModal);
    $("introOk").addEventListener("click", ()=>{ try{ localStorage.setItem("rt_seen_intro_v2","1"); }catch(e){} hideIntroModal(); });

    $("group").max = String(GROUPS.length);
    updateHUD();
    loadGroup(0);
    try{ if(!localStorage.getItem("rt_seen_intro_v2")) showIntroModal(); }catch(e){ showIntroModal(); }
  </script>
</body>
</html>
