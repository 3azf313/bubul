<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Say The Word On Beat â€” ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</title>
  <style>
    :root{
      --bg1:#070b14; --bg2:#0b1533;
      --text:#f3f6ff; --muted:#a9b7da;
      --ok:#2dd4bf; --bad:#fb7185; --warn:#fbbf24;
      --stroke: rgba(255,255,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans Arabic", "Noto Kufi Arabic", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 50% 10%, rgba(255,203,90,.38), transparent 55%),
        radial-gradient(900px 600px at 12% 70%, rgba(122,92,255,.26), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
      padding:14px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .app{width:min(1080px, 100%); display:grid; grid-template-columns: 1fr 360px; gap:14px;}
    @media (max-width: 980px){.app{grid-template-columns: 1fr}}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }

    .stageWrap{display:flex; justify-content:center; margin:4px 0 10px;}
    .stageBanner{
      position:relative;
      padding:10px 18px;
      border-radius:999px;
      background: linear-gradient(90deg, #6d28d9, #9333ea, #7c3aed);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 16px 45px rgba(0,0,0,.35);
      font-weight:900;
      font-size:20px;
      text-align:center;
      min-width: 220px;
    }

    .arenaTop{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .stats{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--stroke);
      color:var(--muted); font-size:13px; white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .pill .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:10px;}
    @media (max-width: 520px){.grid{gap:10px}}
    .card{
      position:relative; aspect-ratio: 1 / 1;
      border-radius: 16px;
      border:2px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:flex; align-items:stretch; justify-content:stretch;
      box-shadow: 0 14px 30px rgba(0,0,0,.26);
    }
    .cardInner{width:100%; height:100%; padding:10px; display:grid; grid-template-rows: 1fr auto; gap:8px;}
    .iconBox{
      border-radius: 12px; display:flex; align-items:center; justify-content:center;
      font-size:38px; border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 999px rgba(255,255,255,.03);
    }
    .wordLabel{
      text-align:center; font-weight:900; font-size:20px;
      padding:8px 10px; border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    @media (max-width: 520px){.iconBox{font-size:34px} .wordLabel{font-size:18px}}

    .t-green .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(34,197,94,.55), rgba(16,185,129,.22));}
    .t-blue  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(59,130,246,.55), rgba(99,102,241,.22));}
    .t-gold  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(251,191,36,.55), rgba(245,158,11,.22));}
    .t-red   .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(239,68,68,.58), rgba(251,113,133,.18));}
    .t-purple .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(168,85,247,.55), rgba(99,102,241,.18));}
    .t-pink  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(180deg, rgba(236,72,153,.55), rgba(168,85,247,.18));}
    .t-gray  .iconBox{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.22), transparent 55%), linear-gradient(180deg, rgba(148,163,184,.35), rgba(59,130,246,.10));}

    .card.active{
      outline: 4px solid rgba(251,191,36,.95);
      box-shadow: 0 0 0 6px rgba(251,191,36,.22), 0 18px 55px rgba(0,0,0,.35);
      transform: translateY(-1px);
    }
    .card.active::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 50%, rgba(251,191,36,.30), transparent 60%);
      animation: pulse .6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulse{
      0%{opacity:.35; transform: scale(.9)}
      50%{opacity:.9; transform: scale(1)}
      100%{opacity:.35; transform: scale(.9)}
    }

    .playWrap{display:flex; justify-content:center; align-items:center; flex-direction:column; gap:10px; margin-top:12px;}
    .playBtn{
      width:min(580px, 100%);
      border:0; border-radius: 20px;
      padding:16px 16px;
      font-weight:900; font-size:20px;
      color:var(--text);
      background: rgba(45,212,191,.18);
      border:1px solid rgba(45,212,191,.38);
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(0,0,0,.26);
      -webkit-tap-highlight-color: transparent;
    }
    @media (max-width: 520px){
      .playBtn{font-size:18px; padding:14px 14px; border-radius:18px;}
    }
    .playBtn:active{transform: translateY(1px)}
    .playBtn:disabled{opacity:.5; cursor:not-allowed}
.nextBtn{background: rgba(99,102,241,.16); border:1px solid rgba(99,102,241,.38)}

/* Modal */
.modal.hidden{display:none}
.modal{position:fixed; inset:0; z-index:50; display:flex; align-items:center; justify-content:center; padding:16px;}
.modalBackdrop{position:absolute; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(4px);}
.modalCard{position:relative; width:min(560px, 100%); border-radius:22px; border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); box-shadow: 0 24px 80px rgba(0,0,0,.55);
  padding:14px;
}
.modalHeader{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 6px 10px;}
.modalTitle{font-weight:900; font-size:18px;}
.modalX{border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); color: var(--text);
  width:38px; height:38px; border-radius:12px; cursor:pointer; font-weight:900;
}
.modalBody{padding:6px;}
.modalScore{font-weight:900; font-size:26px; margin:4px 0 8px;}
.modalSmall{color: var(--muted); font-size:13px; line-height:1.6;}
.modalActions{display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:8px 6px 2px;}
@media (max-width:520px){.modalActions{grid-template-columns:1fr}}

    .h2{margin:0 0 10px; font-size:16px; font-weight:900;}
    .hint{margin:0 0 10px; color:var(--muted); font-size:12px; line-height:1.6;}
    .row{display:grid; gap:8px; margin-bottom:10px;}
    label{display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:13px;}
    input[type="range"]{width:100%}
    select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }

    .log{max-height: 340px; overflow:auto; display:flex; flex-direction:column; gap:8px;}
    .logItem{
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--muted); font-size:13px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .tag{
      padding:6px 10px; border-radius:999px;
      font-weight:900; color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      white-space:nowrap; background: rgba(255,255,255,.08);
    }
    .tag.ok{border-color: rgba(45,212,191,.38); background: rgba(45,212,191,.16)}
    .tag.bad{border-color: rgba(251,113,133,.38); background: rgba(251,113,133,.14)}
    .tag.warn{border-color: rgba(251,191,36,.38); background: rgba(251,191,36,.14)}
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="stageWrap"><div class="stageBanner" id="stageTitle">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</div></div>

      <div class="arenaTop">
        <div class="stats">
          <div class="pill">ğŸ§© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b id="groupText">1</b>/<b id="groupTotal">16</b></div>
          <div class="pill">ğŸšï¸ BPM: <b id="bpmText">110</b></div>
          <div class="pill">ğŸ¯ Ø§Ù„Ø¯ÙˆØ±: <b id="stepText">1</b>/8</div>
          <div class="pill">â­ Ø³ÙƒÙˆØ± Ø§Ù„Ø¬ÙˆÙ„Ø©: <b id="scoreText">0</b>/80</div>
          <div class="pill">ğŸ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: <b id="totalScoreText">0</b></div>
          <div class="pill">ğŸ™ï¸ Ø§Ù„Ù…Ø§ÙŠÙƒ: <b id="micState">ØºÙŠØ± Ù…ÙØ¹Ù„</b></div>
          <div class="pill">ğŸ§  Ø§Ù„ØªØ¹Ø±Ù: <b id="asrState">ØºÙŠØ± Ù…ÙØ¹Ù„</b></div>
          <div class="pill">ğŸ—£ï¸ Ø¢Ø®Ø± Ø³Ù…Ø§Ø¹: <b class="mono" id="lastHeard">â€”</b></div>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="playWrap">
        <button class="playBtn" id="playBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>
        <button class="playBtn nextBtn" id="nextStageBtn">â­ï¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
      </div>
    </div>

    <div class="panel">
      <div class="h2">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="row">
        <label><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><span id="groupLabel">1 / 16</span></label>
        <input type="range" id="group" min="1" max="16" value="1">
      </div>

      <div class="row">
        <label><span>BPM</span><span id="bpmLabel">110</span></label>
        <input type="range" id="bpm" min="70" max="160" value="110">
      </div>

      <div class="row">
        <label><span>Ù„ØºØ© Ø§Ù„ØªØ¹Ø±Ù‘Ù</span><span id="langLabel">ar-SA</span></label>
        <select id="asrLang">
          <option value="ar-SA" selected>ar-SA (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
          <option value="ar-IQ">ar-IQ (Ø§Ù„Ø¹Ø±Ø§Ù‚)</option>
          <option value="ar-EG">ar-EG (Ù…ØµØ±)</option>
          <option value="ar">ar (Ø¹Ø§Ù…)</option>
        </select>
      </div>

      <div class="row">
        <label><span>Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØª</span><span id="sensLabel">Ù…ØªØ³Ø§Ù‡Ù„</span></label>
        <select id="sens">
          <option value="strict">ØµØ§Ø±Ù…</option>
          <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
          <option value="loose" selected>Ù…ØªØ³Ø§Ù‡Ù„</option>
        </select>
      </div>

      <div class="row">
        <button id="resetBtn" style="border-radius:14px;padding:10px 12px;font-weight:900;color:var(--text);background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);cursor:pointer;">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„/Ø§Ù„Ø³ÙƒÙˆØ±</button>
      </div>

      <div class="h2" style="margin-top:6px">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</div>
      <div class="log" id="log"></div>

      
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
  <div id="finalModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
    <div class="modalBackdrop" id="finalBackdrop"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalTitle" id="finalTitle">ğŸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
        <button class="modalX" id="finalClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      </div>
      <div class="modalBody">
        <div class="modalScore" id="finalScoreLine">â€”</div>
        <div class="modalSmall" id="finalDetailLine">â€”</div>
      </div>
      <div class="modalActions">
        <button class="playBtn nextBtn" id="finalRestart">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
        <button class="playBtn" id="finalOk">âœ… ØªÙ…</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
    const now=()=>performance.now();

    function normalizeArabic(s){
      return (s||"")
        .toLowerCase()
        .replace(/[Ù‘ÙÙ‹ÙÙŒÙÙÙ’Ù€]/g,"")
        .replace(/[Ø£Ø¥Ø¢Ø§]/g,"Ø§")
        .replace(/[Ù‰ÙŠ]/g,"ÙŠ")
        .replace(/[Ø©]/g,"Ù‡")
        .replace(/[Ø¤]/g,"Ùˆ")
        .replace(/[Ø¦]/g,"ÙŠ")
        .replace(/[^\u0600-\u06FF0-9a-z ]+/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    // ===== Speech Recognition (collect full round) =====
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer=null;
    let recogRunning=false;

    let finalTranscript = "";     // appended when isFinal
    let lastInterim = "";         // latest interim
    let allowAsrRestart = false;
    let asrPhase = "idle"; // idle | playing | ending

    function setMicState(txt){ $("micState").textContent = txt; }
    function setAsrState(txt){ $("asrState").textContent = txt; }

    function isSpeechSupported(){
      return !!SpeechRec;
    }

    function isSecure(){
      // Web Speech API ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠØ­ØªØ§Ø¬ https (Ø£Ùˆ localhost)
      return (window.isSecureContext || location.hostname === "localhost" || location.hostname === "127.0.0.1");
    }

    function setupRecognizer(){
      if(!SpeechRec) return false;
      recognizer = new SpeechRec();
      // NOTE: "ar" Ù…Ø±Ø§Øª ÙŠØ·Ù„Ø¹ Ø¶Ø¹ÙŠÙØŒ ÙØ®Ù„ÙŠÙ‘Ù†Ø§ Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ© Ù…Ø¶Ø¨ÙˆØ·
      recognizer.lang = $("asrLang").value || "ar-SA";
      recognizer.interimResults = true;
      recognizer.continuous = true;
      recognizer.maxAlternatives = 3;

      recognizer.onstart = ()=> { setAsrState("Ø´ØºØ§Ù„"); };

      recognizer.onresult = (ev)=>{
        // Ø¨Ø¹Ø¶ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Web Speech ØªØ±Ø¬Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø´ÙƒÙ„ "ØªØ±Ø§ÙƒÙ…ÙŠ" (ÙƒÙ„ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„Ø¬Ù…Ù„Ø© Ù„Ø­Ø¯ Ø§Ù„Ø¢Ù†)
        // Ø£Ùˆ ØªØ±Ø¬Ø¹ Ù…Ù‚Ø§Ø·Ø¹ Ù…Ù†ÙØµÙ„Ø©. Ø¥Ø°Ø§ Ù†Ø¬Ù…Ø¹Ù‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ÙŠØµÙŠØ± ØªÙƒØ±Ø§Ø± Ø¶Ø®Ù….
        // Ø§Ù„Ø­Ù„: Ù†Ø¬Ù…Ø¹ Ø¨Ø´ÙƒÙ„ Ø°ÙƒÙŠ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (overlap merge).

        const segs = [];
        for(let i=0;i<ev.results.length;i++){
          const r = ev.results[i];
          const txtRaw = (r && r[0] && r[0].transcript) ? r[0].transcript : "";
          const seg = normalizeArabic(txtRaw);
          if(seg) segs.push(seg);
        }

        let merged = "";
        for(const seg of segs){
          if(!merged){
            merged = seg;
            continue;
          }

          // Ø¥Ø°Ø§ seg ØªØ­ØªÙˆÙŠ merged Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (ØªØ±Ø§ÙƒÙ…ÙŠ) Ø§Ø³ØªØ¨Ø¯Ù„
          if(seg.startsWith(merged)){
            merged = seg;
            continue;
          }
          // Ø¥Ø°Ø§ seg Ù…Ø¬Ø±Ø¯ prefix Ù…Ù† mergedØŒ ØªØ¬Ø§Ù‡Ù„
          if(merged.startsWith(seg)){
            continue;
          }

          const a = merged.split(" ");
          const b = seg.split(" ");
          let overlap = 0;
          const max = Math.min(a.length, b.length);
          for(let k=max; k>=1; k--){
            if(a.slice(-k).join(" ") === b.slice(0,k).join(" ")){
              overlap = k;
              break;
            }
          }
          merged = a.concat(b.slice(overlap)).join(" ");
        }

        finalTranscript = normalizeArabic(merged);
        lastInterim = "";

        const show = finalTranscript;
        $("lastHeard").textContent = show ? (show.length>28 ? show.slice(0,28)+"â€¦" : show) : "â€”";
      };

      recognizer.onerror = (e)=>{
        const err = (e && e.error) ? e.error : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        // Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©: not-allowed | audio-capture | network | service-not-allowed
        setAsrState("Ø®Ø·Ø£: " + err);
        // Ø¥Ø°Ø§ ØµØ§Ø± audio-capture Ù…Ø±Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ØªØ­Ù„
        if(err === "audio-capture" || err === "network"){
          allowAsrRestart = true;
        }
      };

      recognizer.onend = ()=>{
        if(recogRunning && allowAsrRestart && asrPhase === "playing"){
          try{ recognizer.start(); }catch(e){}
        }else{
          setAsrState("Ù…ØªÙˆÙ‚Ù");
        }
      };

      return true;
    }

    async function startMicAuto(){
      // 1) Ù„Ø§Ø²Ù… https/localhost
      if(!isSecure()){
        setMicState("ÙŠØ­ØªØ§Ø¬ HTTPS");
        setAsrState("ØºÙŠØ± Ø´ØºØ§Ù„");
        log("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§Ø²Ù… ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ https Ø£Ùˆ localhost Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ Ø§Ù„ØªØ¹Ø±Ù‘Ù.","warn");
        return false;
      }

      // 2) Ø¥Ø°Ø§ SpeechRecognition ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
      if(!isSpeechSupported()){
        setMicState("Ù…Ø¯Ø¹ÙˆÙ…");
        setAsrState("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
        log("ØªÙ†Ø¨ÙŠÙ‡","SpeechRecognition ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù‡Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome (Desktop/Android).","warn");
        return false;
      }

      // 3) Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø±ÙŠÙƒÙ†Ø§ÙŠØ²Ø±
      if(!recognizer && !setupRecognizer()){
        setAsrState("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
        return false;
      }

      // 4) Ø´ØºÙ‘Ù„ Ø§Ù„ØªØ¹Ø±Ù‘Ù â€” Ù…Ù† ØºÙŠØ± getUserMedia Ø­ØªÙ‰ Ù…Ø§ ÙŠØµÙŠØ± ØªØ¹Ø§Ø±Ø¶ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
      try{
        recogRunning=true;
        finalTranscript = "";
        lastInterim = "";
        $("lastHeard").textContent = "â€”";
        allowAsrRestart = true;
        asrPhase = "playing";
        recognizer.lang = $("asrLang").value || "ar-SA";
        recognizer.start();
        setMicState("Ø´ØºØ§Ù„");
        setAsrState("Ø´ØºØ§Ù„");
        return true;
      }catch(e){
        setMicState("Ø´ØºØ§Ù„");
        setAsrState("Ù…ØªÙˆÙ‚Ù");
        log("ØªÙ†Ø¨ÙŠÙ‡","Ù…Ø§ ÙƒØ¯Ø±Ù†Ø§ Ù†Ø¨Ø¯ÙŠ SpeechRecognition (ÙŠÙ…ÙƒÙ† Ù…Ø±ÙÙˆØ¶/Ù…Ø´ØºÙ‘Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹). Ø¬Ø±Ù‘Ø¨ ØªØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØªØ³Ù…Ø­ Ù„Ù„Ù…Ø§ÙŠÙƒ.","warn");
        return false;
      }
    }

    function hardStopMic(){
      allowAsrRestart = false;
      recogRunning = false;
      asrPhase = "idle";
      try{ if(recognizer) recognizer.stop(); }catch(e){}
      setMicState("Ù…ØªÙˆÙ‚Ù");
      setAsrState("Ù…ØªÙˆÙ‚Ù");
    }

    // ===== Data =====
    const WORDS = ["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø­Ø§Ø±","Ù†Ø§Ø±","Ø·Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø³ÙˆÙ‚","ÙÙˆÙ‚","ÙØ§Ø±","Ø¬Ø§Ø±"];
    const ICONS = {"Ù†Ø§Ù‚Ø©":"ğŸª","Ø¨Ø§Ù‚Ø©":"ğŸ’","Ø¨ÙˆÙ‚":"ğŸº","Ø­Ø§Ø±":"ğŸŒ¶ï¸","Ù†Ø§Ø±":"ğŸ”¥","Ø·Ø§Ù‚Ø©":"ğŸ’¡","Ø·ÙˆÙ‚":"ğŸ“¿","Ø³ÙˆÙ‚":"ğŸ›’","ÙÙˆÙ‚":"â¬†ï¸","ÙØ§Ø±":"ğŸ­","Ø¬Ø§Ø±":"ğŸšª"};
    const THEME = {"Ù†Ø§Ù‚Ø©":"t-gold","Ø¨Ø§Ù‚Ø©":"t-pink","Ø¨ÙˆÙ‚":"t-purple","Ø­Ø§Ø±":"t-red","Ù†Ø§Ø±":"t-red","Ø·Ø§Ù‚Ø©":"t-green","Ø·ÙˆÙ‚":"t-blue","Ø³ÙˆÙ‚":"t-gold","ÙÙˆÙ‚":"t-gray","ÙØ§Ø±":"t-gray","Ø¬Ø§Ø±":"t-blue"};

    const GROUPS = [
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ø¨Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", tiles:["Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","ÙÙˆÙ‚","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©"] },

      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", tiles:["Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", tiles:["Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±","Ù†Ø§Ø±"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", tiles:["Ù†Ø§Ø±","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø­Ø§Ø±","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø­Ø§Ø±","Ù†Ø§Ø±"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", tiles:["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø·ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ø±","Ø­Ø§Ø±"] },
{ title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", tiles:["Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©","Ø³ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", tiles:["Ø­Ø§Ø±","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", tiles:["Ø¨Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ù†Ø§Ø±","Ù†Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", tiles:["Ø¨Ø§Ù‚Ø©","Ù†Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø¨Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚","Ù†Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", tiles:["Ø·Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ù†Ø§Ù‚Ø©","Ù†Ø§Ø±","Ø­Ø§Ø±","Ø·ÙˆÙ‚","Ø¨ÙˆÙ‚","Ø¨Ø§Ù‚Ø©"] },
      { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", tiles:["ÙØ§Ø±","Ø­Ø§Ø±","Ù†Ø§Ù‚Ø©","Ø·ÙˆÙ‚","Ø¬Ø§Ø±","ÙØ§Ø±","Ù†Ø§Ù‚Ø©","Ø¨ÙˆÙ‚"] }
    ];

    // ===== Game State =====
    let groupIndex=0;
    let bpm=110;
    let intervalMs=60000/bpm;

    let running=false;
    let timer=null;

    let activePos=0;
    let score=0; // Ø³ÙƒÙˆØ± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (0..80)

    // ØªØ¬Ù…ÙŠØ¹ Ø³ÙƒÙˆØ± ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª + Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    let groupScores = new Array(GROUPS.length).fill(0);
    let totalScore = 0;
    let lastRawRound = ""; // Ù†Øµ Ø®Ø§Ù… Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©

    function currentGroup(){ return GROUPS[groupIndex]; }
    function expectedWord(pos){ return currentGroup().tiles[pos] || ""; }

    // ===== UI =====
    function log(tag, msg, type){
      const item=document.createElement("div");
      item.className="logItem";
      const left=document.createElement("div");
      left.textContent=msg;
      const t=document.createElement("div");
      t.className=`tag ${type||""}`;
      t.textContent=tag;
      item.appendChild(left);
      item.appendChild(t);
      $("log").prepend(item);
    }

    function updateHUD(){
      $("stageTitle").textContent = currentGroup().title;
      $("groupText").textContent = (groupIndex+1);
      $("groupTotal").textContent = String(GROUPS.length);
      $("groupLabel").textContent = `${groupIndex+1} / ${GROUPS.length}`;
      $("groupTotal").textContent = String(GROUPS.length);
      $("bpmText").textContent = bpm;
      $("bpmLabel").textContent = bpm;
      $("stepText").textContent = (activePos+1);
      $("scoreText").textContent = score;
      $("totalScoreText").textContent = totalScore;
      $("langLabel").textContent = $("asrLang").value;
      $("sensLabel").textContent = $("sens").value==="strict" ? "ØµØ§Ø±Ù…" : $("sens").value==="loose" ? "Ù…ØªØ³Ø§Ù‡Ù„" : "Ø¹Ø§Ø¯ÙŠ";
    }

    function buildGrid(){
      const g=$("grid");
      g.innerHTML="";
      const tiles=currentGroup().tiles;
      tiles.forEach((w,i)=>{
        const card=document.createElement("div");
        card.className = `card ${THEME[w]||""}`;
        card.dataset.pos = String(i);

        const inner=document.createElement("div");
        inner.className="cardInner";

        const icon=document.createElement("div");
        icon.className="iconBox";
        icon.textContent = ICONS[w] || "âœ¨";

        const label=document.createElement("div");
        label.className="wordLabel";
        label.textContent = w;

        inner.appendChild(icon);
        inner.appendChild(label);
        card.appendChild(inner);
        g.appendChild(card);
      });
      setActive(0);
    }

    function setActive(pos){
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
      const el=document.querySelector(`.card[data-pos="${pos}"]`);
      if(el) el.classList.add("active");
      activePos=pos;
      updateHUD();
    }

    // ===== Matching after end =====
    function voiceMatchesExpected(heard, expected){
      const h=normalizeArabic(heard);
      const e=normalizeArabic(expected);
      if(!h || !e) return false;

      const mode=$("sens").value;
      if(mode==="strict") return h===e;

      const ht = " " + h + " ";
      const et = " " + e + " ";

      if(mode==="normal"){
        return h===e || ht.includes(et) || h.replaceAll(" ","")===e.replaceAll(" ","");
      }

      // loose
      if(h===e) return true;
      if(ht.includes(et)) return true;
      if(h.replaceAll(" ","")===e.replaceAll(" ","")) return true;
      if(e.length>=2 && h.includes(e)) return true;
      return false;
    }

    function extractFirstNWords(text, n){
      const t = normalizeArabic(text);
      if(!t) return [];
      const tokens = t.split(" ").filter(Boolean);
      return tokens.slice(0, n);
    }

    function finalizeRoundAndVerify(){
      const raw = (finalTranscript || lastInterim || "").trim();
      lastRawRound = raw || "";

      const saidSeq = extractFirstNWords(raw, 8); // âœ… ÙÙ‚Ø· Ø£ÙˆÙ„ 8 ÙƒÙ„Ù…Ø§Øª

      if(!raw){
        log("ØªÙ†Ø¨ÙŠÙ‡", "Ù…Ø§ ÙˆØµÙ„Ù†Ø§ Ù†Øµ Ù…Ù† Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ (Ù‚Ø§Ù„: â€”). ØªØ£ÙƒØ¯ Ù…Ù† https + ChromeØŒ ÙˆØ¬Ø±Ù‘Ø¨ ØªØºÙŠÙ‘Ø± Ù„ØºØ© Ø§Ù„ØªØ¹Ø±Ù‘Ù.", "warn");
      } else if(saidSeq.length < 8){
        log("ØªÙ†Ø¨ÙŠÙ‡", `Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ 8 ÙƒÙ„Ù…Ø§ØªØŒ Ø¨Ø³ Ø§Ù„Ù„ÙŠ Ø§Ù†Ø³Ù…Ø¹ ${saidSeq.length}. Ø±Ø§Ø­ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙ‚Ø· ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ÙŠØ¹ØªØ¨Ø± Ø®Ø·Ø£.`, "warn");
      }

      score = 0;
      for(let i=0;i<8;i++){
        const expected = expectedWord(i);
        const said = saidSeq[i] || "â€”";
        const ok = (said !== "â€”") && voiceMatchesExpected(said, expected);
        if(ok){
          score += 10;
          log("âœ… ØµØ­", `#${i+1} Ù‚Ø§Ù„: "${said}" | Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: "${expected}" (+10)`, "ok");
        }else{
          log("âŒ Ø®Ø·Ø£", `#${i+1} Ù‚Ø§Ù„: "${said}" | Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: "${expected}"`, "bad");
        }
      }

      // Ø§Ø­ÙØ¸ Ø³ÙƒÙˆØ± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ Ù„Ù†ÙØ³ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙŠØ³ØªØ¨Ø¯Ù„ Ø³ÙƒÙˆØ±Ù‡Ø§)
      groupScores[groupIndex] = score;
      totalScore = groupScores.reduce((a,b)=>a+(b||0), 0);

      updateHUD();
    }

    // ===== Loop =====
    function scheduleNext(){
      if(!running) return;
      timer = setTimeout(()=>{
        if(!running) return;

        const next = activePos + 1;
        if(next >= 8){
          finishRound();
          return;
        }
        setActive(next);
        scheduleNext();
      }, intervalMs);
    }

    async function finishRound(){
      running=false;
      if(timer) clearTimeout(timer);
      timer=null;

      asrPhase = "ending";
      allowAsrRestart = false;

      // Ù†ÙˆÙ‚Ù Ø§Ù„ØªØ¹Ø±Ù‘Ù ÙˆÙ†Ù†ØªØ¸Ø± Ø´ÙˆÙŠ Ø­ØªÙ‰ ÙŠÙ„Ø­Ù‚ ÙŠÙÙ„Ù‘Ø´ Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø©
      try{ if(recognizer) recognizer.stop(); }catch(e){}
      await new Promise(r=>setTimeout(r, 1200));

      finalizeRoundAndVerify();

      hardStopMic();
      asrPhase = "idle";

      $("playBtn").disabled=false;
      $("nextStageBtn").disabled=false;

      // Ù†Ø®Ù„ÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø¬Ù„" (Ù„Ø£Ù† log() ÙŠØ³ÙˆÙŠ prepend)
      log("Ù†Ù‡Ø§ÙŠØ©", `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©. Ø³ÙƒÙˆØ±: ${score}/80 | Ù…Ø¬Ù…ÙˆØ¹: ${totalScore}`, "warn");
      log("Ù†Øµ Ø®Ø§Ù…", lastRawRound ? lastRawRound : "â€”", "warn");
    }

    async function startGame(){
      if(running) return;

      const playEl = $("playBtn");
      const nextEl = $("nextStageBtn");
      const originalText = playEl.textContent;

      playEl.disabled=true;
      nextEl.disabled=true;

      // Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ Ø³Ø±ÙŠØ¹ 3..0
      for(let i=3;i>=0;i--){
        playEl.textContent = `â³ ${i}`;
        await new Promise(r=>setTimeout(r, 260));
      }
      playEl.textContent = "ğŸ™ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒâ€¦";

      $("log").innerHTML = "";

      bpm = clamp(parseInt($("bpm").value,10)||110, 40, 220);
      intervalMs = 60000 / bpm;

      // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
      await startMicAuto();

      running=true;
      score=0; // Ø³ÙƒÙˆØ± Ù‡Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      activePos=0;

      buildGrid();
      log("Ø¨Ø¯Ø¡", "Ø³Ø¬Ù„Ù†Ø§ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø©â€¦ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø±Ø§Ø­ ÙŠØ·Ù„Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚.", "warn");

      if(timer) clearTimeout(timer);
      scheduleNext();

      // Ø±Ø¬Ù‘Ø¹ Ù†Øµ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
      playEl.textContent = originalText;
    }

    function loadGroup(idx){
      groupIndex = clamp(idx, 0, GROUPS.length-1);
      running=false;
      if(timer) clearTimeout(timer);
      timer=null;
      hardStopMic();

      // Ø§Ø¹Ø±Ø¶ Ø³ÙƒÙˆØ± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸
      score = groupScores[groupIndex] || 0;
      totalScore = groupScores.reduce((a,b)=>a+(b||0), 0);
      activePos=0;
      finalTranscript="";
      lastInterim="";
      $("lastHeard").textContent="â€”";

      buildGrid();
      updateHUD();

      $("log").innerHTML="";
      $("playBtn").disabled=false;
      $("nextStageBtn").disabled=false;
      log("Ø¬Ø§Ù‡Ø²", `Ø§Ø®ØªØ±Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${groupIndex+1} â€” Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨`, "warn");
    }

    // ===== Events =====
    $("playBtn").addEventListener("click", startGame);

    $("nextStageBtn").addEventListener("click", ()=>{
      if(running) return;

      // Ø¥Ø°Ø§ Ø¢Ø®Ø± Ø¬ÙˆÙ„Ø©ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¯Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
      if(groupIndex === GROUPS.length - 1){
        showFinalModal();
        return;
      }

      const next = (groupIndex + 1) % GROUPS.length;
      $("group").value = String(next + 1);
      loadGroup(next);
    });

    $("group").addEventListener("input", (e)=>{
      loadGroup((parseInt(e.target.value,10)||1)-1);
    });

    $("bpm").addEventListener("input", (e)=>{
      bpm = clamp(parseInt(e.target.value,10)||110, 40, 220);
      intervalMs = 60000 / bpm;
      $("bpmLabel").textContent=bpm;
      $("bpmText").textContent=bpm;
    });

    $("sens").addEventListener("change", updateHUD);
    $("asrLang").addEventListener("change", ()=>{
      updateHUD();
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´ØºØ§Ù„ ÙˆØºÙŠÙ‘Ø±Øª Ø§Ù„Ù„ØºØ©ØŒ Ø£ÙˆÙ‚Ù ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø´ØºÙ‘Ù„ Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¬Ø§ÙŠØ© (Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±)
      if(recogRunning){
        try{ if(recognizer) recognizer.stop(); }catch(e){}
      }
    });

    $("resetBtn").addEventListener("click", ()=>{
      $("log").innerHTML="";
      groupScores = new Array(GROUPS.length).fill(0);
      totalScore = 0;
      score=0;
      activePos=0;
      finalTranscript="";
      lastInterim="";
      $("lastHeard").textContent="â€”";
      updateHUD();
      log("ØªØµÙÙŠØ±","ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„/Ø§Ù„Ø³ÙƒÙˆØ±","warn");
    });

    function showFinalModal(){
      const played = groupScores.filter(s=>s>0).length;
      const maxTotal = GROUPS.length * 80;
      const pct = maxTotal ? Math.round((totalScore / maxTotal) * 100) : 0;
      $("finalScoreLine").textContent = `Ø§Ù„Ø³ÙƒÙˆØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${totalScore} / ${maxTotal}`;
      $("finalDetailLine").textContent = `Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: ${played} / ${GROUPS.length} â€” Ù†Ø³Ø¨Ø©: ${pct}%`;
      $("finalModal").classList.remove("hidden");
    }

    function hideFinalModal(){
      $("finalModal").classList.add("hidden");
    }

    $("finalBackdrop").addEventListener("click", hideFinalModal);
    $("finalClose").addEventListener("click", hideFinalModal);
    $("finalOk").addEventListener("click", hideFinalModal);
    $("finalRestart").addEventListener("click", ()=>{
      hideFinalModal();
      // Ø±Ø¬Ù‘Ø¹ Ù„Ø£ÙˆÙ„ Ø¬ÙˆÙ„Ø©
      $("group").value = "1";
      loadGroup(0);
    });

    // Init
    // Ø§Ø±Ø¨Ø· Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
    $("group").max = String(GROUPS.length);

    if(!isSecure()){
      setMicState("ÙŠØ­ØªØ§Ø¬ HTTPS");
      setAsrState("ØºÙŠØ± Ø´ØºØ§Ù„");
      log("ØªÙ†Ø¨ÙŠÙ‡","Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ https Ø£Ùˆ localhost Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø§Ù„ØµÙˆØªÙŠ.","warn");
    }else if(!isSpeechSupported()){
      setMicState("Ù…Ø¯Ø¹ÙˆÙ…");
      setAsrState("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
      log("ØªÙ†Ø¨ÙŠÙ‡","SpeechRecognition ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… (Ø§Ù„Ù…ÙŠÙƒ Ù…Ù…ÙƒÙ† ÙŠØ´ØªØºÙ„ Ø¨Ø³ Ù…Ø§ ÙŠØ­ÙˆÙ„ ÙƒÙ„Ø§Ù… Ù„Ù†Øµ).","warn");
    }else{
      setMicState("ØºÙŠØ± Ù…ÙØ¹Ù„");
      setAsrState("ØºÙŠØ± Ù…ÙØ¹Ù„");
    }

    updateHUD();
    loadGroup(0);
  </script>
</body>
</html>
